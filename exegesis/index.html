<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>exegesis</title>
  <link rel="icon" href="/content/fav/ex_512.png" type="image/png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      background: black;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: black;
    }
    .container img {
      width:100%;
      max-width:1600px;
      height:auto;
      display:block;
      background:black;
      pointer-events:none;
      opacity:0;
      transition: opacity 0.5s;
    }

    .loading_container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 10px 0; 
      /* не fixed, чтобы двигался вниз по мере вставки img */
    }
    .loading_container img {
      width: 64px; /* или любой размер gif */
      height: 64px;
    }
  </style>
</head>
<body>


<div class="container" id="container">
  <img src="/content/exegesis/e_1_alt.png" style="opacity:1;">
</div>

<div class="loading_container" id="loading_container">
  <img src="/content/loading.gif">
</div>

<script>
const images = [
  {src: "/content/exegesis/e_2_alt.png", w: 1400, h: 745},
  {src: "/content/exegesis/e_3_alt.png", w: 1400, h: 1104},
  {src: "/content/exegesis/e_4_alt.png", w: 1400, h: 1704},
  {src: "/content/exegesis/e_5_alt.png", w: 1400, h: 1450},
  {src: "/content/exegesis/e_6_alt.png", w: 1400, h: 1665},
  {src: "/content/exegesis/e_7_alt.png", w: 1400, h: 1575},
  {src: "/content/exegesis/e_8_alt.png", w: 1400, h: 1575}
];

const container = document.getElementById("container");
const firstImg = document.querySelector('#container img');
const loader = document.getElementById("loading_container");


async function loadFirstImageWithRetries(imgEl, maxRetries = 5, delay = 1000) {
  let attempts = 0;

  while (attempts < maxRetries) {
    // Если картинка уже полностью загружена
    if (imgEl.complete && imgEl.naturalHeight !== 0) {
      imgEl.style.opacity = 1; // показываем
      return imgEl;
    }

    try {
      await new Promise((resolve, reject) => {
        imgEl.onload = () => resolve();
        imgEl.onerror = () => reject();
      });

      imgEl.style.opacity = 1;
      return imgEl;

    } catch {
      attempts++;
      console.warn(`Ошибка загрузки первой картинки, попытка ${attempts}`);
      await new Promise(r => setTimeout(r, delay));
    }
  }

  console.error("Не удалось загрузить первую картинку после всех попыток");
  return null;
}



// функция для загрузки одной картинки с повторной попыткой
function loadImage(src, maxRetries = 5, delay = 1000) {
  return new Promise((resolve, reject) => {
    let attempts = 0;

    function tryLoad() {
      const img = document.createElement("img");
      img.src = src;
      img.onload = () => resolve(img);
      img.onerror = () => {
        attempts++;
        console.warn(`Ошибка загрузки: ${src}, попытка ${attempts}`);
        if (attempts < maxRetries) {
          setTimeout(tryLoad, delay); // пробуем снова через задержку
        } else {
          reject(new Error(`Не удалось загрузить ${src} после ${maxRetries} попыток`));
        }
      };
    }

    tryLoad();
  });
}

async function loadSequentially(list) {
  for (const item of list) {
    try {
      const img = await loadImage(item.src); // <- используем item.src
      img.width = item.w;  // задаём размеры
      img.height = item.h;
      img.style.opacity = 1;
      container.appendChild(img);
    } catch (e) {
      console.error(e);
      break; // если хотим строго последовательность, выходим
    }
  }
  loader.style.display = "none";
}

// Используем перед загрузкой последовательного списка
loadFirstImageWithRetries(firstImg).then(() => loadSequentially(images));

// ESC — выход со страницы
function handleEscape(e) {
  if (e.key === "Escape") {
    if (window.location.protocol === "file:") {
      window.location.href = "./index.html";
    } else {
      window.history.back();
    }
  }
}

// Подписываем один обработчик на оба объекта
window.addEventListener('keydown', handleEscape);
document.addEventListener('keydown', handleEscape);

</script>

</body>
</html>
