<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" href="/content/fav/f_id.png" type="image/png">
<link rel="apple-touch-icon" sizes="180x180" href="/content/fav/f_w_id.png">

<script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

<title>identity</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      height: 100%;
      background: black;
      flex-direction: column;

    }
    .page_container {
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      width: 100%;
      height: 100vh;
      overflow: hidden;
      background: black;
    }

    .content {
      transform-origin: center center; /* масштабирование из центра */
      transition: transform 0.3s ease; /* плавное увеличение/уменьшение */
    }

    .page_container img {
      width: 100vw;
      height: auto;
      object-fit: cover;
      background-position: center;
      background-size: contain; /* КЛЮЧ */
    }

    .page_container button {
      font-size: 1.3rem;
      transition: transform 0.3s ease; /* плавная анимация */
    }


    .page_container button .highlight {
      color: rgba(90,90,90,1);
      font-size: 1.15rem;

      text-decoration: underline; 
      text-decoration-color: rgba(90,90,90,.1); 
      text-decoration-thickness: 1px; 

    }

    .page_container button:hover .highlight {
      color: rgba(117,117,117,1);
      text-decoration-color: rgba(117,117,117,1);
    }

    .page_container button .special {
      color: rgba(110,110,110,1); 
      font-size: 1.4rem; 


      text-decoration: underline;
      text-decoration-color: rgba(90,90,90,.7);
      text-decoration-thickness: 1px;

    }

    .page_container button:hover .special {
      color: rgba(150,150,150,1);
      text-decoration-color: rgba(117,117,117,1);
    }


    .text_block {
      position: relative;
      font-family: sans-serif;
      user-select: text;
      line-height: 1.6;
      box-sizing: border-box;    /* ! */
      width: 40vw;
      
    }

    .text_block .head {
      font-size: 21px;
      font-weight: 300;
    }

    .text_block .text {
      font-size: 15px;
      margin: 12px;
      margin-left: 0px;
    }



    .node-stage {
      position: relative;

      width: 1400px;
      height: 580px;

      /* адаптация */
      max-width: 100%;
      aspect-ratio: 4 / 3;
    }

    .node-stage-wrap {
      width: 100%;
      display: flex;
      justify-content: center;
    }

    /* SVG живёт ВНУТРИ stage */
    .connections {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .connections line {
      stroke: black;
      stroke-width: 1;
      vector-effect: non-scaling-stroke;
      z-index: 99;
    }

    /* кнопки */
    .node {
      position: absolute;
      width: 42px;
      height: 42px;
      transform: translate(-50%, -50%);
      background: transparent;
      border: none;
      border-radius: 50%;
      z-index: 2;
    }

    /* координаты ВНУТРИ 800×600 */
    .node[data-id="A"] { left: 280px; top: 340px; }
    .node[data-id="B"] { left: 620px; top: 500px; }
    .node[data-id="C"] { left: 1180px; top: 80px; }



    .scene {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      perspective: 800px;
    }

    .layer {
      position: absolute;
      inset: 0;
      background-position: center;
      background-repeat: no-repeat;
      background-size: cover;
      will-change: transform;
      pointer-events: none;

    }

  </style>



</head>
<body>



<div class="page_container">
  <div class="content">
    <img src="/content/identity/img/i_img_0.png">
  </div>
</div>

<div class="page_container">
  <div class="content">

    <div class="scene" id="scene">

      <div class="layer" data-depth="0.00"
           style="background-image:url('/content/identity/pyra/py_bg.png')"></div>

      <div class="layer" data-depth="0.08"
           style="background-image:url('/content/identity/stars.png')"></div>

      <div class="layer" data-depth="0.09"
           style="background-image:url('/content/identity/pyra/py_small_new.png')"></div>

      <div class="layer" data-depth="0.12"
           style="background-image:url('/content/identity/pyra/py_big.png')"></div>

      <div class="layer" data-depth="0.25"
           style="background-image:url('/content/identity/dust.png')"></div>


    </div>

  </div>
</div>



<div class="page_container" style="background:#cfced1;">
  <div class="content">

    <div class="node-stage-wrap">
      <div class="node-stage">

        <svg class="connections">
          <line id="lineAB"/>
          <line id="lineBC"/>
        </svg>

        <button class="node" data-id="A">
          <div class="lottie-ring" id="lottieA"></div>
        </button>

        <button class="node" data-id="B">
          <div class="lottie-ring" id="lottieB"></div>
        </button>

        <button class="node" data-id="C">
          <div class="lottie-ring" id="lottieC"></div>
        </button>

      </div>
    </div>

  </div>
</div>



<div class="page_container">
  <div class="content">
    <img src="/content/identity/img/i_img_3.png">
  </div>
</div>


<div class="page_container"style="background-color: black;">
  <div class="content" style="background-color: #cfced1;">

    <div class="scene" id="scene">

      <div class="layer" data-depth="0.15" data-zoom="1.1"
           style="background-image:url('/content/identity/line/line_c.png')"></div>

      <div class="layer" data-depth="0.50" data-zoom="1.2"
           style="background-image:url('/content/identity/line/line_d.png'); 
           
           "></div>

    </div>

  </div>
</div>


<div class="page_container">
  <div class="content">
    <img src="/content/identity/img/i_img_5.png">
  </div>
</div>



<div class="page_container lottie-section" style="background-color: #cfced1;">
  <div class="content">
    <div id="lottie-scroll" style="width:60vw; height:60vh;"></div>
  </div>
</div>

<div class="page_container">
  <div class="content">
    <img src="/content/identity/img/i_img_7.png">
  </div>
</div>

<div class="page_container">
  <div class="content">
    <img src="/content/identity/img/i_img_8.png">
  </div>
</div>

<div class="page_container">
  <div class="content">
    <img src="/content/identity/img/i_img_9.png">
  </div>
</div>

<div class="page_container">
  <div class="content">
    <img src="/content/identity/img/i_img_10.png">
  </div>
</div>

<div class="page_container">
  <div class="content">
    <img src="/content/identity/img/i_img_11.png">
  </div>
</div>

<div class="page_container" style="background-color: #dadada;">
  <div class="content">
    <img src="/content/identity/img/i_img_12.png">
  </div>
</div>

<div class="page_container" style="background-color: #dadada;">
  <div class="content">

    <div class="text_block" >
      <div class="head">Дизайнеры:</div>
      <div class="text"style="margin-top:24px;">
        Виктор Александровский<br>
        Даниил Стерхов <br>
        Виктор Копейкин<br><br><br><br>
      <div class="head">Поддержка:</div>
      <div class="text"style="margin-top:24px;">
        Дмитрий Бережной<br>
        Евгений Стерхов <br>
        Ксения Новокшёнова<br><br><br>

        2016 г.
      </div>
    </div>

  </div>
</div>

<script>

const buttons = document.querySelectorAll('.page_container button');
const images = document.querySelectorAll('.page_container img');

function fitImagesInContainer() {
  document.querySelectorAll('.page_container').forEach(container => {
    const img = container.querySelector('img');
    if (!img || !img.naturalWidth) return;

    const cw = container.clientWidth;
    const ch = container.clientHeight;
    const iw = img.naturalWidth;
    const ih = img.naturalHeight;

    const scale = Math.max(cw / iw, ch / ih);

    img.style.width = iw + 'px';
    img.style.height = ih + 'px';
    img.style.transform = `scale(${scale})`;
    img.style.transformOrigin = 'center center';
  });
}

window.addEventListener('load', fitImagesInContainer);
window.addEventListener('resize', fitImagesInContainer);

document.querySelectorAll('.scene').forEach(scene => {
  const layers = scene.querySelectorAll('.layer');

  let mouseX = 0, mouseY = 0;
  let gyroX = 0, gyroY = 0;
  let useGyro = false;

  const update = () => {
    layers.forEach(layer => {
      const depth = parseFloat(layer.dataset.depth) || 0;
      const x = (useGyro ? gyroX : mouseX) * depth;
      const y = (useGyro ? gyroY : mouseY) * depth;
      const zoom = layer.dataset.zoom || 1;
      layer.style.transform = `
        translate3d(${x}px, ${y}px, 0)
        scale(${zoom})
      `;
    });
    requestAnimationFrame(update);
  };

  scene.addEventListener('mousemove', e => {
    const rect = scene.getBoundingClientRect();
    mouseX = (e.clientX - rect.left - rect.width / 2) * -0.2;
    mouseY = (e.clientY - rect.top  - rect.height / 2) * -0.2;
  });

  window.addEventListener('deviceorientation', e => {
    if (e.beta != null && e.gamma != null) {
      useGyro = true;
      gyroX = e.gamma * 2;
      gyroY = e.beta * 2;
    }
  });

  update();
});



buttons.forEach(btn => {
  btn.addEventListener('click', e => {
    const href = btn.dataset.href;
    if (!href) return; 
    window.open(href, '_blank');
  });
});

function handleEscape(e) {
  if (e.key === "Escape") {
    if (window.location.protocol === "file:") {
      window.location.href = "./index.html";
    } else {
      window.history.back();
    }
  }
}

// Подписываем один обработчик на оба объекта
window.addEventListener('keydown', handleEscape);
document.addEventListener('keydown', handleEscape);


// Зумирование на пк через ctrl

let scale = 1;
const containers = document.querySelectorAll('.page_container');


document.addEventListener('wheel', e => {
  if (e.ctrlKey) {
    e.preventDefault();
    scale += e.deltaY * -0.001;
    scale = Math.min(Math.max(0.5, scale), 3);

    containers.forEach(container => {
      container.querySelector('.content').style.transform = `scale(${scale})`;
    });
  }
}, { passive: false });

// Зумирование на телефоне

let pinchStartDist = null;
let pinchStartScale = scale;

document.addEventListener('touchstart', e => {
  if (e.touches.length === 2) {
    pinchStartDist = getTouchDist(e.touches);
    pinchStartScale = scale;
  }
}, { passive: false });

document.addEventListener('touchmove', e => {
  if (e.touches.length === 2 && pinchStartDist) {
    e.preventDefault();

    const currentDist = getTouchDist(e.touches);
    const zoomFactor = currentDist / pinchStartDist;

    scale = pinchStartScale * zoomFactor;
    scale = Math.min(Math.max(0.15, scale), 3);

    containers.forEach(container => {
      container.querySelector('.content').style.transform = `scale(${scale})`;
    });
  }
}, { passive: false });

document.addEventListener('touchend', e => {
  if (e.touches.length < 2) {
    pinchStartDist = null;
  }
});

function getTouchDist(touches) {
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.hypot(dx, dy);
}

// Lottie block

/* -------------------------------
   Lottie Button
-------------------------------- */

function connectNodes(a, b, line) {
  const ax = a.offsetLeft;
  const ay = a.offsetTop;

  const bx = b.offsetLeft;
  const by = b.offsetTop;

  line.setAttribute('x1', ax);
  line.setAttribute('y1', ay);
  line.setAttribute('x2', bx);
  line.setAttribute('y2', by);
}

const nodeA = document.querySelector('.node[data-id="A"]');
const nodeB = document.querySelector('.node[data-id="B"]');
const nodeC = document.querySelector('.node[data-id="C"]');

const lineAB = document.getElementById('lineAB');
const lineBC = document.getElementById('lineBC');

function updateConnections() {
  connectNodes(nodeA, nodeB, lineAB);
  connectNodes(nodeB, nodeC, lineBC);
}
window.addEventListener('load', updateConnections);
window.addEventListener('resize', updateConnections);

const stage = document.querySelector('.node-stage');
const svg = document.querySelector('.connections');

function resizeSVG() {
  const rect = stage.getBoundingClientRect();
  svg.setAttribute('width', rect.width);
  svg.setAttribute('height', rect.height);
  svg.setAttribute('viewBox', `0 0 ${rect.width} ${rect.height}`);
}

window.addEventListener('load', resizeSVG);
window.addEventListener('resize', resizeSVG);


const wiggleNodes = ['A', 'C']
  .map(id => document.querySelector(`.node[data-id="${id}"]`));

const start = performance.now();

function wiggle(time, {
  freq = 0.1,
  amp = 20,
  seed = 0
}) {
  return (
    Math.sin(time * freq + seed) +
    Math.sin(time * freq * 1.7 + seed * 2) * 0.5
  ) * amp;
}
const basePositions = new Map();

document.querySelectorAll('.node').forEach(node => {
  basePositions.set(node, {
    x: node.offsetLeft,
    y: node.offsetTop
  });
});
const nodes = {
  A: { x: 280, y: 340 },
  B: { x: 620, y: 500 },
  C: { x: 1180, y: 80 }
};
Object.values(nodes).forEach(p => {
  p.wx = p.x;
  p.wy = p.y;
});

function render() {
  // кнопки
  Object.entries(nodes).forEach(([id, p]) => {
    const el = document.querySelector(`.node[data-id="${id}"]`);
    el.style.left = `${p.wx}px`;
    el.style.top  = `${p.wy}px`;
  });

  // линии
  lineAB.setAttribute('x1', nodes.A.wx);
  lineAB.setAttribute('y1', nodes.A.wy);
  lineAB.setAttribute('x2', nodes.B.wx);
  lineAB.setAttribute('y2', nodes.B.wy);

  lineBC.setAttribute('x1', nodes.B.wx);
  lineBC.setAttribute('y1', nodes.B.wy);
  lineBC.setAttribute('x2', nodes.C.wx);
  lineBC.setAttribute('y2', nodes.C.wy);
}

function animate() {
  const time = (performance.now() - start) / 1000;

  wiggleNodes.forEach((node, i) => {
    const id = node.dataset.id;
    const base = nodes[id];

    const dx = wiggle(time, { freq: 0.6, amp: 14, seed: i * 10 });
    const dy = wiggle(time, { freq: 0.8, amp: 14, seed: i * 20 });

    base.wx = base.x + dx;
    base.wy = base.y + dy;
  });

  render();
  requestAnimationFrame(animate);
}

animate();


function initRing(buttonId) {
  const container = document.getElementById(buttonId);

  const anim = lottie.loadAnimation({
    container,
    renderer: 'svg',
    loop: false,
    autoplay: false,
    path: '/content/lottie/button_hover.json'
  });

  let tween = null;

  function playTo(frame) {
    if (tween) tween.kill();

    tween = gsap.to({ f: anim.currentFrame }, {
      f: frame,
      duration: 0.25,
      ease: 'none',
      onUpdate() {
        anim.goToAndStop(this.targets()[0].f, true);
      }
    });
  }

  const btn = container.closest('.node');

  btn.addEventListener('pointerenter', () => {
    playTo(anim.totalFrames - 1);
  });

  btn.addEventListener('pointerleave', () => {
    playTo(0);
  });
}

initRing('lottieA');
initRing('lottieB');
initRing('lottieC');



/* -------------------------------
   Lottie Sequence
-------------------------------- */

gsap.registerPlugin(ScrollTrigger);


let isPlaying = false;
let hasPlayed = false;
let lottieReady = false;
let playTween = null;

const FPS = 50;

const lottieAnim = lottie.loadAnimation({
  container: document.getElementById('lottie-scroll'),
  renderer: 'svg',
  loop: false,
  autoplay: false,
  path: '/content/lottie/anim_incl_pause.json'
});

lottieAnim.addEventListener('DOMLoaded', () => {
  lottieReady = true;
});

/* -------------------------------
   PLAY
-------------------------------- */

function playLottie() {
  if (!lottieReady || isPlaying || hasPlayed) return;

  hasPlayed = true;
  isPlaying = true;

  playTween = gsap.to({ frame: 0 }, {
    frame: lottieAnim.totalFrames - 1,
    duration: lottieAnim.totalFrames / FPS,
    ease: 'none',

    onUpdate() {
      lottieAnim.goToAndStop(
        Math.round(this.targets()[0].frame),
        true
      );
    },

    onComplete() {
      isPlaying = false;
    }
  });
}

/* -------------------------------
   RESET (ONLY WHEN ABOVE)
-------------------------------- */

function resetLottie() {
  if (isPlaying && playTween) {
    playTween.kill();
  }

  hasPlayed = false;
  isPlaying = false;

  lottieAnim.goToAndStop(0, true);
}

/* -------------------------------
   VISIBILITY TRIGGER
-------------------------------- */

ScrollTrigger.create({
  trigger: '.lottie-section',

  // ~30% блока видно
  start: 'top 70%',

  // блок полностью ушёл ВВЕРХ
  end: 'bottom top',

  onEnter: () => {
    playLottie();
  },

  onLeaveBack: () => {
    resetLottie();
  }

  // onLeave — НЕ НУЖЕН
});
</script>



</body>
</html>
